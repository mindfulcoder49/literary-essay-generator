<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Literary Essays MVP</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fraunces:wght@300;600&family=Space+Grotesk:wght@400;600&display=swap" rel="stylesheet">
    <style>
      :root {
        --bg: #0f1a2b;
        --bg-soft: #1b2a3f;
        --panel: #f3efe7;
        --ink: #1a1a1a;
        --accent: #c97c5d;
        --accent-2: #6aa6b8;
        --muted: #6b7280;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: "Space Grotesk", system-ui, -apple-system, sans-serif;
        color: var(--ink);
        background: radial-gradient(circle at top left, #223451 0%, var(--bg) 35%, #0b1320 100%);
        min-height: 100vh;
      }
      header {
        padding: 32px 24px 8px;
        color: #f7f3ec;
      }
      header h1 {
        margin: 0 0 8px;
        font-family: "Fraunces", serif;
        font-weight: 600;
        letter-spacing: 0.5px;
      }
      header p {
        margin: 0;
        color: #d6d1c5;
      }
      .wrap {
        max-width: 1100px;
        margin: 0 auto;
        padding: 0 24px 48px;
        display: grid;
        gap: 24px;
        grid-template-columns: minmax(280px, 1fr) minmax(300px, 1.2fr);
      }
      .panel {
        background: var(--panel);
        border-radius: 18px;
        padding: 20px;
        box-shadow: 0 20px 60px rgba(7, 10, 18, 0.35);
      }
      .panel h2 {
        margin-top: 0;
        font-family: "Fraunces", serif;
      }
      label {
        display: block;
        font-weight: 600;
        margin-bottom: 6px;
      }
      input, button, textarea {
        font-family: inherit;
        font-size: 1rem;
      }
      input[type="text"], input[type="number"] {
        width: 100%;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid #c9c3b8;
      }
      button {
        background: var(--accent);
        color: #fff;
        border: none;
        padding: 10px 16px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
      }
      button.secondary {
        background: var(--accent-2);
      }
      button.ghost {
        background: transparent;
        border: 1px solid #b7b0a4;
        color: var(--ink);
      }
      .row {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }
      .stack {
        display: grid;
        gap: 12px;
      }
      .muted { color: var(--muted); }
      .result {
        white-space: pre-wrap;
        background: #fff;
        border-radius: 12px;
        padding: 12px;
        max-height: 320px;
        overflow: auto;
        border: 1px solid #e3ded4;
        font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
        font-size: 0.9rem;
      }
      .pill {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 999px;
        background: #fff;
        border: 1px solid #e3ded4;
        margin-right: 6px;
        margin-bottom: 6px;
        font-size: 0.9rem;
      }
      .status {
        font-weight: 600;
      }
      .footer {
        color: #d6d1c5;
        text-align: center;
        padding-bottom: 24px;
      }
      @media (max-width: 900px) {
        .wrap { grid-template-columns: 1fr; }
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Literary Essays MVP</h1>
      <p>Search Gutenberg, launch a job, and inspect themes, evidence, and the essay.</p>
    </header>

    <main class="wrap">
      <section class="panel stack">
        <div>
          <h2>1. Search Gutenberg</h2>
          <label for="search">Search term</label>
          <div class="row">
            <input id="search" type="text" placeholder="e.g. pride and prejudice" />
            <button id="searchBtn">Search</button>
          </div>
          <p class="muted">Results show ID, title, and author. Pick an ID to run a job.</p>
        </div>
        <div>
          <h2>2. Create Job</h2>
          <label for="bookId">Gutenberg ID</label>
          <div class="row">
            <input id="bookId" type="number" min="1" placeholder="e.g. 1342" />
            <button id="jobBtn" class="secondary">Generate</button>
          </div>
          <p class="muted">The worker will ingest if needed, then generate themes and essay.</p>
        </div>
        <div>
          <h2>3. Check Job</h2>
          <label for="jobId">Job ID</label>
          <div class="row">
            <input id="jobId" type="text" placeholder="Paste job UUID" />
            <button id="statusBtn" class="ghost">Check Status</button>
            <button id="resultBtn" class="ghost">Fetch Result</button>
          </div>
        </div>
      </section>

      <section class="panel stack">
        <div>
          <h2>Status</h2>
          <div class="status" id="statusText">Idle</div>
          <div class="muted" id="statusMeta"></div>
        </div>
        <div>
          <h2>Themes</h2>
          <div id="themes"></div>
        </div>
        <div>
          <h2>Evidence</h2>
          <div class="result" id="evidence"></div>
        </div>
        <div>
          <h2>Essay</h2>
          <div class="result" id="essay"></div>
        </div>
        <div>
          <h2>Search Results</h2>
          <div class="result" id="searchResults"></div>
        </div>
      </section>
    </main>

    <div class="footer">Local MVP UI • FastAPI + Pinecone + OpenAI</div>

    <script>
      const searchBtn = document.getElementById("searchBtn");
      const jobBtn = document.getElementById("jobBtn");
      const statusBtn = document.getElementById("statusBtn");
      const resultBtn = document.getElementById("resultBtn");

      const searchInput = document.getElementById("search");
      const bookIdInput = document.getElementById("bookId");
      const jobIdInput = document.getElementById("jobId");

      const statusText = document.getElementById("statusText");
      const statusMeta = document.getElementById("statusMeta");
      const themesEl = document.getElementById("themes");
      const evidenceEl = document.getElementById("evidence");
      const essayEl = document.getElementById("essay");
      const searchResultsEl = document.getElementById("searchResults");

      function setStatus(text, meta) {
        statusText.textContent = text;
        statusMeta.textContent = meta || "";
      }

      function setThemes(themes) {
        themesEl.innerHTML = "";
        (themes || []).forEach(t => {
          const span = document.createElement("span");
          span.className = "pill";
          span.textContent = t;
          themesEl.appendChild(span);
        });
      }

      async function searchGutenberg() {
        const q = searchInput.value.trim();
        if (!q) return;
        setStatus("Searching Gutenberg...", "");
        const res = await fetch(`/gutenberg/search?q=${encodeURIComponent(q)}`);
        if (!res.ok) {
          setStatus("Search failed", `HTTP ${res.status}`);
          return;
        }
        const data = await res.json();
        const lines = data.results.map(r => {
          const author = (r.authors && r.authors[0] && r.authors[0].name) || "Unknown";
          return `${r.id} — ${r.title} — ${author}`;
        });
        searchResultsEl.textContent = lines.join("\n");
        setStatus("Search complete", `${data.count} results`);
      }

      async function createJob() {
        const id = Number(bookIdInput.value);
        if (!id) return;
        setStatus("Creating job...", "");
        const res = await fetch("/jobs", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ gutenberg_id: id })
        });
        if (!res.ok) {
          const text = await res.text();
          setStatus("Job create failed", text);
          return;
        }
        const data = await res.json();
        jobIdInput.value = data.id;
        localStorage.setItem("lastJobId", data.id);
        setStatus("Job created", data.id);
      }

      async function checkStatus() {
        const jobId = jobIdInput.value.trim();
        if (!jobId) return;
        const res = await fetch(`/jobs/${jobId}`);
        if (!res.ok) {
          setStatus("Status failed", `HTTP ${res.status}`);
          return;
        }
        const data = await res.json();
        setStatus(`Job ${data.status}`, data.job_type);
      }

      async function fetchResult() {
        const jobId = jobIdInput.value.trim();
        if (!jobId) return;
        const res = await fetch(`/jobs/${jobId}/result`);
        if (!res.ok) {
          const text = await res.text();
          setStatus("Result not ready", text);
          return;
        }
        const data = await res.json();
        setThemes(data.themes || []);
        evidenceEl.textContent = JSON.stringify(data.evidence || {}, null, 2);
        essayEl.textContent = data.essay_markdown || "";
        setStatus("Result ready", jobId);
      }

      searchBtn.addEventListener("click", searchGutenberg);
      jobBtn.addEventListener("click", createJob);
      statusBtn.addEventListener("click", checkStatus);
      resultBtn.addEventListener("click", fetchResult);

      const lastJobId = localStorage.getItem("lastJobId");
      if (lastJobId) jobIdInput.value = lastJobId;
    </script>
  </body>
</html>
